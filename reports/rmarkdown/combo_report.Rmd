---
title:  "`r toupper(params$solo_name)` Combination Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  data_dir: ~/Desktop/MTS016_final/MTS016_VALIDATION_COMPOUND_INTERNAL
  solo_name: venetoclax
  combo_dose: NA
  combo_names: S64315
output: 
  html_document:
    theme: paper
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10)

# packages
library(tidyverse)
library(psych)
library(magrittr)
library(ggthemes)
library(plotly)
library(crosstalk)
library(htmltools)
library(DT)
library(heatmaply)
library(viridis)
library(synergyfinder)

# theme
theme_set(theme_bw())
```

```{r define functions, include=FALSE}
# DRC curve function
dr_func <- function(d, x) {
  as.numeric(d["lower_limit"]) + (as.numeric(d["upper_limit"]) - as.numeric(d["lower_limit"]))/
    (1 + (2^x/as.numeric(d["ec50"]))^as.numeric(d["slope"]))
}

# DRC curve maker
dr_wrapper <- function(d, xx) {
  out_df <- tibble(x = xx, y = dr_func(xx))
  colnames(out_df) <- c(x, d["pert_name"])
  return(out_df$y)
}
```

```{r load data, include=FALSE}
# log-fold change
lfc <- data.table::fread(file.path(params$data_dir, "data/LFC_TABLE.csv"))

dose_idose <- dplyr::distinct(lfc, pert_idose, pert_dose) %>%
  dplyr::arrange(pert_dose) %>%
  .$pert_idose %>% unique()
dose_idose <- c("0 uM", dose_idose, "log2.ic50", "log2.auc") %>% unique()

lfc.combos <- lfc %>%
  dplyr::filter(str_detect(pert_name, params$solo_name)) %>%
  dplyr::mutate(combination = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                     word(pert_name, 2, sep = fixed("_")),
                                     word(pert_name, 1, sep = fixed("_"))),
                combo_dose = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                    word(pert_name, 3, sep = fixed("_")),
                                    word(pert_name, 2, sep = fixed("_"))),
                combo_dose = ifelse(combo_dose == params$solo_name, NA, combo_dose)) %>%
  dplyr::mutate(combination = ifelse(is.na(combination), "None", combination),
                combo_dose = ifelse(combination == "None", "0 uM", combo_dose))

# dose response
drc <- data.table::fread(file.path(params$data_dir, "data/DRC_TABLE.csv"))
drc.combos <- drc %>%
  dplyr::filter(str_detect(pert_name, params$solo_name)) %>%
  dplyr::mutate(combination = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                     word(pert_name, 2, sep = fixed("_")),
                                     word(pert_name, 1, sep = fixed("_"))),
                combo_dose = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                    word(pert_name, 3, sep = fixed("_")),
                                    word(pert_name, 2, sep = fixed("_"))),
                combo_dose = ifelse(combo_dose == params$solo_name, NA, combo_dose)) %>%
  dplyr::mutate(combination = ifelse(is.na(combination), "None", combination),
                combo_dose = ifelse(combination == "None", "0 uM", combo_dose))


# extract combination alone data
if(params$combo_names == "NA") {
  combo_names <- setdiff(unique(lfc.combos$combination), "None")
} else {
  combo_names <- unlist(stringr::str_split(params$combo_names, pattern = "::"))
  lfc.combos %<>% dplyr::filter(combination %in% c(combo_names, "None"))
  drc.combos %<>% dplyr::filter(combination %in% c(combo_names, "None"))
}
if (params$combo_dose != "NA") {
  combo_doses <- unlist(stringr::str_split(params$combo_dose, pattern = "::"))
}

lfc.combo_alone <- lfc %>%
  dplyr::filter(pert_name %in% combo_names) %>%
  {if (params$combo_dose != "NA") dplyr::filter(., pert_idose %in% combo_doses) else .}

# biomarkers
correlations <- data.table::fread(file.path(params$data_dir, "results/continuous_associations.csv")) %>%
  dplyr::filter(q.val <= 0.1) %>%
  dplyr::mutate(feature = word(feature, 2, -1, sep = fixed("_")))
correlations %<>%
  dplyr::filter(str_detect(pert_name, params$solo_name)) %>%
  dplyr::mutate(combination = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                     word(pert_name, 2, sep = fixed("_")),
                                     word(pert_name, 1, sep = fixed("_"))),
                combo_dose = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                    word(pert_name, 3, sep = fixed("_")),
                                    word(pert_name, 2, sep = fixed("_"))),
                combo_dose = ifelse(combo_dose == params$solo_name, NA, combo_dose)) %>%
  dplyr::mutate(combination = ifelse(is.na(combination), "None", combination),
                combo_dose = ifelse(combination == "None", "0 uM", combo_dose)) %>%
  dplyr::filter(combination %in% c(combo_names, "None"))

rf_results <- data.table::fread(file.path(params$data_dir, "results/RF_table.csv")) %>%
  dplyr::left_join(data.table::fread(file.path(params$data_dir, "results/Model_table.csv"))) %>%
  dplyr::filter(str_detect(pert_name, params$solo_name)) %>%
  dplyr::mutate(combination = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                     word(pert_name, 2, sep = fixed("_")),
                                     word(pert_name, 1, sep = fixed("_"))),
                combo_dose = ifelse(word(pert_name, 1, sep = fixed("_")) == params$solo_name,
                                    word(pert_name, 3, sep = fixed("_")),
                                    word(pert_name, 2, sep = fixed("_"))),
                combo_dose = ifelse(combo_dose == params$solo_name, NA, combo_dose)) %>%
  dplyr::mutate(combination = ifelse(is.na(combination), "None", combination),
                combo_dose = ifelse(combination == "None", "0 uM", combo_dose)) %>%
  dplyr::filter(combination %in% c(combo_names, "None"))

# make doses into factors
added_doses <- dplyr::distinct(lfc.combo_alone, pert_name, pert_dose, pert_idose)
lfc.combos %<>%
  dplyr::mutate(combo_dose = ifelse(combination %in% combo_names & is.na(combo_dose),
                                    added_doses$pert_idose[match(combination, added_doses$pert_name)],
                                    combo_dose))
drc.combos %<>%
  dplyr::mutate(combo_dose = ifelse(combination %in% combo_names & is.na(combo_dose),
                                    added_doses$pert_idose[match(combination, added_doses$pert_name)],
                                    combo_dose))
correlations %<>%
  dplyr::mutate(combo_dose = ifelse(combination %in% combo_names & is.na(combo_dose),
                                    added_doses$pert_idose[match(combination, added_doses$pert_name)],
                                    combo_dose))
rf_results %<>%
  dplyr::mutate(combo_dose = ifelse(combination %in% combo_names & is.na(combo_dose),
                                    added_doses$pert_idose[match(combination, added_doses$pert_name)],
                                    combo_dose))

lfc.combos %<>%
  dplyr::mutate(pert_idose = factor(pert_idose, levels = dose_idose),
                combo_dose = factor(combo_dose, levels = dose_idose))
drc.combos %<>%
  dplyr::mutate(combo_dose = factor(combo_dose, levels = dose_idose))

correlations %<>%
  dplyr::mutate(dose = factor(dose, levels = dose_idose),
                combo_dose = factor(combo_dose, levels = dose_idose))
rf_results %<>%
  dplyr::mutate(dose = factor(dose, levels = dose_idose),
                combo_dose = factor(combo_dose, levels = dose_idose))

# distinct conditions (cell lines)
conditions <- drc.combos %>%
  dplyr::arrange(auc) %>%
  dplyr::distinct(ccle_name, culture, pert_time)

# generate plots for each cell line
drc_plots <- list()
for (i in 1:nrow(conditions)) {
  condition <- conditions[i,]
  
  cell_line <- condition$ccle_name
  culture <- condition$culture
  pert_time <- condition$pert_time
  
  d <- drc.combos %>% dplyr::inner_join(condition, by = c("ccle_name", "culture", "pert_time"))
  xx = seq(log2(min(d$min_dose)), log2(max(d$max_dose)), length.out = 10)
  res <- apply(d, 1, function(p) dr_func(p, xx))
  func_tab <- cbind(xx, res); colnames(func_tab) <- c("x", d$pert_name)
  func_tab %<>% as_tibble() %>%
    tidyr::pivot_longer(cols = c(2:ncol(.)), names_to = "pert_name", values_to = "y") %>%
    dplyr::mutate(ccle_name = condition$ccle_name, culture = condition$culture, pert_time = condition$pert_time) %>%
    dplyr::left_join(drc.combos, by = c("pert_name", "ccle_name", "culture", "pert_time"))
  drc_plots[[i]] <- func_tab
}
drc_plots %<>% dplyr::bind_rows()
drc_plots %<>% 
  dplyr::mutate(pert_name = ifelse(combination == "None", pert_name, paste(params$solo_name, combination, combo_dose)),
                combination = ifelse(combination == "None", pert_name, paste(params$solo_name, combination)))
drc_meta <- drc_plots %>%
  dplyr::distinct(ccle_name, culture, combination, combo_dose, auc, log2.ic50) %>%
  dplyr::select(c(5,6,1:4)) %>%
  dplyr::group_by(ccle_name, culture) %>%
  dplyr::mutate(auc_ratio = ifelse(!is.null(auc[combo_dose == "0 uM"]), auc[combo_dose == "0 uM"], 1)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(auc_ratio = auc/auc_ratio)

ssmd <- data.table::fread(file.path(params$data_dir, "results/SSMD_TABLE.csv"))
ssmd_collapsed <- ssmd %>%
  dplyr::select(-prism_replicate, -rid, -pass) %>%
  dplyr::group_by(ccle_name, culture, pool_id, compound_plate, pert_time) %>%
  dplyr::summarise_all(.funs = median) %>%
  dplyr::ungroup()

# # synergy calculation
# bliss_table <- lfc.combos %>%
#   dplyr::group_by(ccle_name, culture, pert_time, pool_id, pert_name, pert_dose, pert_idose, combination, combo_dose) %>%
#   dplyr::summarise(LFC.cb = median(LFC.cb), .groups = "drop") %>%
#   dplyr::mutate(conc_c = as.numeric(word(combo_dose, 1, sep = fixed(" "))),
#                 conc_r = pert_dose, 
#                 response = 2^LFC.cb *  100,
#                 drug_col = combination,
#                 drug_row = params$solo_name,
#                 conc_c_unit = "uM", conc_r_unit = "uM") %>%
#   dplyr::bind_rows(lfc.combo_alone %>%
#                      dplyr::group_by(ccle_name, culture, pool_id, pert_name, pert_dose, pert_idose, pert_time) %>%
#                      dplyr::summarise(LFC.cb = median(LFC.cb), .groups = "drop") %>%
#                      dplyr::mutate(conc_c = pert_dose, drug_col = pert_name,
#                                    conc_r = 0, drug_row = params$solo_name,
#                                    conc_c_unit = "uM", conc_r_unit = "uM",
#                                    response = 2^LFC.cb *  100)) %>%
#   dplyr::select(drug_row, drug_col, conc_c, conc_r, response, conc_c_unit, conc_r_unit, ccle_name, culture, pool_id, pert_time)

# color palette
pal <- RColorBrewer::brewer.pal(length(drc.combos$combo_dose %>% unique()), "Set2")
```
# Overview 

This is the combination report for `r params$solo_name` (which will be called the "index" compound for the remainder of the report).The added "anchor" compounds and doses combined with this index compound are shown in the table below:

```{r overview}
DT::datatable(added_doses %>% dplyr::distinct(pert_name, pert_idose) %>% dplyr::select(c(2, 1)),
              options = list(dom = "t", ordering = FALSE), colnames = c("Compound", "Dose"))
```

# Log-fold change {.tabset .tabset-pills}

## Overview

This section contains two plots.

The first shows a comparison of index compound log-fold change at each dose (x-axis) with index compound + anchor compound at each dose (y-axis). Cell lines that are significantly above the $y=x$ line are more sensitive to the index compound alone, while cell lines that are significantly below are more sensitive to the combination.

The second shows synergy score (x-axis) and the significance of that score (y-axis). Synergy score is calculated as $LFC_i + LFC_a - LFC_c$ where $LFC_i$ is index compound log-fold change, $LFC_a$ is the anchor, and $LFC_c$ is the combination. Large positive values indicate synergy while large negative values indicate antagonism. Signifcance metrics, $q$ values, are obtained by normalizing the synergy score to the variance of the cell line abundance in DMSO, calculating a $p$ value and correcting it for multiple hypothesis testing.

## Plots

```{r lfc plot, fig.height=5}
lfc_collapsed <- lfc.combos %>%
  dplyr::group_by(ccle_name, culture, pool_id, pert_idose, pert_name,
                  combination, combo_dose, pert_mfc_id, compound_plate) %>%
  dplyr::summarise(LFC = median(LFC.cb), .groups = "drop")

spread_lfc <- lfc_collapsed %>%
  dplyr::filter(pert_name != params$solo_name) %>%
  dplyr::left_join(lfc_collapsed %>%
                     dplyr::filter(pert_name == params$solo_name) %>%
                     dplyr::distinct(ccle_name, culture, pool_id, pert_idose, pert_idose, LFC) %>%
                     dplyr::rename(test_LFC = LFC))
spread_lfc %>%
  ggplot(aes(x = test_LFC, y = LFC, color = combo_dose, text = paste(ccle_name, culture))) +
  geom_abline(linetype = "dashed") + geom_point(alpha = 0.5) +
  facet_grid(combination ~ pert_idose) +
  labs(x = "Index compound LFC", y = "Combination LFC", color = "Dose") +
  scale_color_manual(values = pal)

```

## Synergy

```{r synergy scoring}
spread_lfc %<>%
  dplyr::left_join(lfc.combo_alone %>%
                     dplyr::group_by(ccle_name, culture, pool_id, compound_plate, pert_idose, pert_name, pert_mfc_id) %>%
                     dplyr::summarise(anchor_LFC = median(LFC.cb), .groups = "drop") %>%
                     dplyr::rename(combination = pert_name, combo_dose = pert_idose) %>%
                     dplyr::select(ccle_name, culture, combination, combo_dose, anchor_LFC)) %>%
  dplyr::left_join(ssmd_collapsed) %>%
  dplyr::mutate(B =  2^(test_LFC + anchor_LFC) - 2^LFC,
                S =   test_LFC + anchor_LFC - LFC ,
                Z  = S / ctl_vehicle_mad / sqrt(pi / 2 )) %>%
  dplyr::mutate(p = 2*pnorm(abs(Z), lower.tail = F)) %>%
  dplyr::group_by(pert_name) %>%
  dplyr::mutate(q = p.adjust(p, method = "BH"))

pal2 <- RColorBrewer::brewer.pal(length(spread_lfc$pert_idose %>% unique()), "Set2")
names(pal2) <- spread_lfc$pert_idose %>% unique()

combos <- spread_lfc %>% dplyr::distinct(combination, combo_dose)

plots <- list()
show_legend = T
for (i in 1:nrow(combos)) {
  if (i != 1) show_legend = F
  synergy_plot <- highlight_key(spread_lfc %>% dplyr::inner_join(combos),
                                 ~ccle_name, group = "Synergy scores")
  p <- plot_ly(synergy_plot) %>% 
    add_trace(x = ~S, y = ~-log10(q), type = "scatter", mode = "markers",
              hoverinfo = "text", text = ~ccle_name, color = ~pert_idose,
              colors = pal2, legendgroup = ~pert_idose, opacity = 0.5,
              showlegend = show_legend) %>%
    layout(xaxis = list(title = "Synergy score"), yaxis = list(title = "-log10(q-value)"), hovermode = "closest",
           annotations = list(x = 0, y = 1,
                              text = paste("Added combination:", paste(combos$combination[[i]], combos$combo_dose[[i]])),
                              align = "left", showarrow = F, xref="paper", yref="paper", xanchor = "left", yanchor = "top")) %>%
    highlight(on = "plotly_click", off = "plotly_doubleclick",
              dynamic = FALSE, selectize = FALSE, persistent = FALSE,
              defaultValues = "", selected = attrs_selected(opacity = 1))
  plots[[i]] <- p
}
subplot(plots, nrows = max(1, floor(length(plots)/2)), shareX = T, shareY = T)
```

# Dose-response curves {.tabset .tabset-pills}

## Overview

Plotted here are the dose-response curves for each cell line in the assay. The curves are fit for the index compound alone as well as the index + anchor combinations. Some cell lines may be missing due to insensitivity and/or inability to fit a standard curve to the data (see a standard PRISM report for more information on curve fitting techniques). The AUC ratio column in the table represents the ratio of the AUC with the combination to the AUC without the combination, thus an AUC ratio $<1$ corresponds to increased sensitivity with the addition of the anchor while and AUC ratio $>1$ corresponds to decreased sensitivity. Data is split into the different cell sets by tab.

## PR500

To highlight a cell line either enter its name in the text box or select a row from the table below.

```{r dose response 500, fig.height=4}
curves_500 <- highlight_key(drc_plots %>%
                              dplyr::filter(culture == "PR500", is.finite(auc)) %>%
                              dplyr::arrange(auc),
                            ~ccle_name, group = "PR500 cell lines")
p <- plot_ly(curves_500) %>% 
  add_trace(x = ~x, y = ~y, type = "scatter", mode = "lines", line = list(shape = "spline"),
            hoverinfo = "text", text = ~ccle_name, opacity = 0.1, color = ~pert_name) %>%
  layout(xaxis = list(title = "Dose"),
         yaxis = list(title = "Viability", rangemode = "nonnegative"),
         hovermode = "closest") %>%
  highlight(on = "plotly_selected", off = "plotly_deselect",
            dynamic = FALSE, selectize = TRUE, persistent = FALSE,
            opacityDim = 1, defaultValues = "",
            selected = attrs_selected(opacity = 1))

compounds_500 <- highlight_key(drc_meta %>% 
                                 dplyr::filter(culture == "PR500", is.finite(auc)) %>% 
                                 dplyr::arrange(auc_ratio),
                               ~ccle_name, group = "PR500 cell lines")
dt <- DT::datatable(compounds_500, style="bootstrap", width="100%",
                    options = list(lengthChange = FALSE, scrollY = "300px", paging = FALSE, dom = "t"),
                    colnames = c("Compound", "Added Dose", "Cell Line", "Culture", "AUC", "log2(IC50)", "AUC Ratio"),
                    selection = "single", filter = "top") %>%
  DT::formatRound(columns = c("auc", "log2.ic50", "auc_ratio"), digits = 3)
p; dt
```

## PR300P

To highlight a cell line either enter its name in the text box or select a row from the table below.

```{r dose response 300, fig.height=4}
curves_300 <- highlight_key(drc_plots %>%
                              dplyr::filter(culture == "PR300P", is.finite(auc)) %>%
                              dplyr::arrange(auc),
                            ~ccle_name, group = "PR300P cell lines")
p <- plot_ly(curves_300) %>% 
  add_trace(x = ~x, y = ~y, type = "scatter", mode = "lines", line = list(shape = "spline"),
            hoverinfo = "text", text = ~ccle_name, opacity = 0.1, color = ~pert_name) %>%
  layout(xaxis = list(title = "Dose"),
         yaxis = list(title = "Viability", rangemode = "nonnegative"),
         hovermode = "closest") %>%
  highlight(on = "plotly_selected", off = "plotly_deselect",
            dynamic = FALSE, selectize = TRUE, persistent = FALSE,
            opacityDim = 1, defaultValues = "",
            selected = attrs_selected(opacity = 1))

compounds_300 <- highlight_key(drc_meta %>% 
                                 dplyr::filter(culture == "PR300P", is.finite(auc)) %>% 
                                 dplyr::arrange(auc_ratio),
                               ~ccle_name, group = "PR300P cell lines")
dt <- DT::datatable(compounds_300, style="bootstrap", width="100%",
                    options = list(lengthChange = FALSE, scrollY = "300px", paging = FALSE, dom = "t"),
                    colnames = c("Compound", "Added Dose", "Cell Line", "Culture", "AUC", "log2(IC50)", "AUC Ratio"),
                    selection = "single", filter = "top") %>%
  DT::formatRound(columns = c("auc", "log2.ic50", "auc_ratio"), digits = 3)
p; dt
```

# Continuous associations {.tabset .tabset-pills}

## Overview

Results from correlation with various DepMap data sets. For simplicity and visualization these results are limited to correlations with AUC values from the index compound alone and the index compound + anchor(s).

## Gene expression {.tabset .tabset-fade}

### Plots

To highlight a gene either click on a point or select a row from the table below. Selecting a gene will highlight it in every in which it appears. 

```{r gene expression}
features_ge <- correlations %>%
  dplyr::filter(feature_type == "GE", is.finite(coef), is.finite(q.val), dose == "log2.auc") %>%
  dplyr::arrange(pert_name)
combos <- features_ge$combination %>% unique()
names(pal) <- features_ge$combo_dose %>% unique()

plots <- list()
show_legend = T
for (i in 1:length(combos)) {
  if (i != 1) show_legend = F
  volcano_combo <- highlight_key(features_ge %>% dplyr::filter(combination == combos[[i]]),
                                 ~feature, group = "GE correlations")
  p <- plot_ly(volcano_combo) %>% 
    add_trace(x = ~coef, y = ~-log10(q.val), type = "scatter", mode = "markers",
              hoverinfo = "text", text = ~feature, opacity = 0.2, color = ~combo_dose,
              colors = pal, legendgroup = ~combo_dose, showlegend = show_legend) %>%
    layout(xaxis = list(title = "Correlation coefficient"), yaxis = list(title = "-log10(q-value)"), hovermode = "closest",
           annotations = list(x = 0, y = 1, text = paste("Added combination:", combos[[i]]), align = "left",
                              showarrow = F, xref="paper", yref="paper", xanchor = "left", yanchor = "top")) %>%
    highlight(on = "plotly_click", off = "plotly_doubleclick",
              dynamic = FALSE, selectize = FALSE, persistent = FALSE,
              opacityDim = 1, defaultValues = "",
              selected = attrs_selected(opacity = 1))
  plots[[i]] <- p
}
features_combo <- features_ge %>%
  dplyr::select(feature, pert_name, coef, q.val) %>%
  dplyr::mutate(coef = signif(coef, digits = 3), q.val = signif(q.val, digits = 3)) %>%
  dplyr::rename("Correlation" = coef, "q-value" = q.val) %>%
  tidyr::pivot_wider(names_from = "pert_name", values_from = c("Correlation", "q-value"),
                     names_sep = fixed(" "))
features_combo_dt <- highlight_key(features_combo, ~feature, group = "GE correlations")
dt <- DT::datatable(features_combo_dt, style="bootstrap", width="100%",
                    options = list(dom = "t", lengthChange = FALSE, scrollY = "300px", scrollX = "300px", paging = FALSE),
                    filter = "top")
subplot(plots, nrows = max(1, floor(length(plots)/2)), shareX = T, shareY = T)
dt
```

### Heatmap

Rank of gene expression features that appear in the top 10 of one of the conditions. `NA` value indicates a rank below 100 for that feature in that condition.

```{r expression heatmap, fig.height=5}
top_feats <- features_ge %>% dplyr::filter(rank <= 10) %>% .$feature %>% unique()
top_tab <- features_ge %>%
  dplyr::filter(feature %in% top_feats) %>%
  reshape2::acast(pert_name ~ feature, value.var = "rank", fun.aggregate = min)
top_tab <- top_tab[,order(apply(top_tab, 2, function(x) min(x, na.rm = T) - max(x, na.rm = T))), drop = F]
top_tab[top_tab > 100] <- NA
heatmaply::heatmaply(top_tab, Rowv = F, Colv = F, colors = viridis(n = 256, direction = -1),
                     key.title = "Rank", label_names = c("Compound", "Gene", "Rank"))
```

## CRISPR dependency {.tabset .tabset-fade}

### Plots

To highlight a gene either click on a point or select a row from the table below. Selecting a gene will highlight it in every in which it appears. 

```{r crispr}
features_xpr <- correlations %>%
  dplyr::filter(feature_type == "XPR", is.finite(coef), is.finite(q.val), dose == "log2.auc") %>%
  dplyr::arrange(pert_name)
combos <- features_xpr$combination %>% unique()
names(pal) <- features_xpr$combo_dose %>% unique()

plots <- list()
show_legend = T
for (i in 1:length(combos)) {
  if (i != 1) show_legend = F
  volcano_combo <- highlight_key(features_xpr %>% dplyr::filter(combination == combos[[i]]),
                                 ~feature, group = "XPR correlations")
  p <- plot_ly(volcano_combo) %>% 
    add_trace(x = ~coef, y = ~-log10(q.val), type = "scatter", mode = "markers",
              hoverinfo = "text", text = ~feature, opacity = 0.2, color = ~combo_dose,
              colors = pal, legendgroup = ~combo_dose, showlegend = show_legend) %>%
    layout(xaxis = list(title = "Correlation coefficient"), yaxis = list(title = "-log10(q-value)"), hovermode = "closest",
           annotations = list(x = 0, y = 1, text = paste("Added combination:", combos[[i]]), align = "left",
                              showarrow = F, xref="paper", yref="paper", xanchor = "left", yanchor = "top")) %>%
    highlight(on = "plotly_click", off = "plotly_doubleclick",
              dynamic = FALSE, selectize = FALSE, persistent = FALSE,
              opacityDim = 1, defaultValues = "",
              selected = attrs_selected(opacity = 1))
  plots[[i]] <- p
}
features_combo <- features_xpr %>%
  dplyr::select(feature, pert_name, coef, q.val) %>%
  dplyr::mutate(coef = signif(coef, digits = 3), q.val = signif(q.val, digits = 3)) %>%
  dplyr::rename("Correlation" = coef, "q-value" = q.val) %>%
  tidyr::pivot_wider(names_from = "pert_name", values_from = c("Correlation", "q-value"),
                     names_sep = fixed(" "))
features_combo_dt <- highlight_key(features_combo, ~feature, group = "XPR correlations")
dt <- DT::datatable(features_combo_dt, style="bootstrap", width="100%",
                    options = list(dom = "t", lengthChange = FALSE, scrollY = "300px", scrollX = "300px", paging = FALSE),
                    filter = "top")
subplot(plots, nrows = max(1, floor(length(plots)/2)), shareX = T, shareY = T)
dt
```

### Heatmap

Rank of CRISPR dependency features that appear in the top 10 of one of the conditions. `NA` value indicates a rank below 100 for that feature in that condition.

```{r crispr heatmap, fig.height=5}
top_feats <- features_xpr %>% dplyr::filter(rank <= 10) %>% .$feature %>% unique()
top_tab <- features_xpr %>%
  dplyr::filter(feature %in% top_feats) %>%
  reshape2::acast(pert_name ~ feature, value.var = "rank", fun.aggregate = min)
top_tab <- top_tab[,order(apply(top_tab, 2, function(x) min(x, na.rm = T) - max(x, na.rm = T))), drop = F]
top_tab[top_tab > 100] <- NA
heatmaply::heatmaply(top_tab, Rowv = F, Colv = F, colors = viridis(n = 256, direction = -1),
                     key.title = "Rank", label_names = c("Compound", "Gene", "Rank"))
```

## Repurposing compounds {.tabset .tabset-fade}

### Plots

To highlight a compound either click on a point or select a row from the table below. Selecting a compound will highlight it in every in which it appears. 

```{r rep}
features_rep <- correlations %>%
  dplyr::filter(feature_type == "REP", is.finite(coef), is.finite(q.val), dose == "log2.auc") %>%
  dplyr::arrange(pert_name)
combos <- features_rep$combination %>% unique()
names(pal) <- features_rep$combo_dose %>% unique()

plots <- list()
show_legend = T
for (i in 1:length(combos)) {
  if (i != 1) show_legend = F
  volcano_combo <- highlight_key(features_rep %>% dplyr::filter(combination == combos[[i]]),
                                 ~feature, group = "REP correlations")
  p <- plot_ly(volcano_combo) %>% 
    add_trace(x = ~coef, y = ~-log10(q.val), type = "scatter", mode = "markers",
              hoverinfo = "text", text = ~feature, opacity = 0.2, color = ~combo_dose,
              colors = pal, legendgroup = ~combo_dose, showlegend = show_legend) %>%
    layout(xaxis = list(title = "Correlation coefficient"), yaxis = list(title = "-log10(q-value)"), hovermode = "closest",
           annotations = list(x = 0, y = 1, text = paste("Added combination:", combos[[i]]), align = "left",
                              showarrow = F, xref="paper", yref="paper", xanchor = "left", yanchor = "top")) %>%
    highlight(on = "plotly_click", off = "plotly_doubleclick",
              dynamic = FALSE, selectize = FALSE, persistent = FALSE,
              opacityDim = 1, defaultValues = "",
              selected = attrs_selected(opacity = 1))
  plots[[i]] <- p
}
features_combo <- features_rep %>%
  dplyr::select(feature, pert_name, coef, q.val) %>%
  dplyr::mutate(coef = signif(coef, digits = 3), q.val = signif(q.val, digits = 3)) %>%
  dplyr::rename("Correlation" = coef, "q-value" = q.val) %>%
  tidyr::pivot_wider(names_from = "pert_name", values_from = c("Correlation", "q-value"),
                     names_sep = fixed(" "))
features_combo_dt <- highlight_key(features_combo, ~feature, group = "REP correlations")
dt <- DT::datatable(features_combo_dt, style="bootstrap", width="100%",
                    options = list(dom = "t", lengthChange = FALSE, scrollY = "300px", scrollX = "300px", paging = FALSE),
                    filter = "top")
subplot(plots, nrows = max(1, floor(length(plots)/2)), shareX = T, shareY = T)
dt
```

### Heatmap

Rank of repurposing features that appear in the top 10 of one of the conditions. `NA` value indicates a rank below 100 for that feature in that condition.

```{r rep heatmap, fig.height=5}
top_feats <- features_rep %>% dplyr::filter(rank <= 10) %>% .$feature %>% unique()
top_tab <- features_rep %>%
  dplyr::filter(feature %in% top_feats) %>%
  reshape2::acast(pert_name ~ feature, value.var = "rank", fun.aggregate = min)
top_tab <- top_tab[,order(apply(top_tab, 2, function(x) min(x, na.rm = T) - max(x, na.rm = T))), drop = F]
top_tab[top_tab > 100] <- NA
heatmaply::heatmaply(top_tab, Rowv = F, Colv = F, colors = viridis(n = 256, direction = -1),
                     key.title = "Rank", label_names = c("Compound", "Compound", "Rank"))
```

# Random forest models {.tabset .tabset-pills}

## Overview

Results from random forests fit to predict response based on multi-omics datasets. For simplicity and visualization these results are limited to models predicting AUC values from the index compound alone and the index compound + anchor(s). For more information on how random forests are fit see a standard PRISM report.

## Results

These plots show the accuracy of predictive models (left) and the features used ranked by importance in each model (right).

``` {r multi ccle, fig.height=8}
rf_ccle_auc <- rf_results %>%
  dplyr::filter(dose == "log2.auc")
p1 <- rf_ccle_auc %>%
  dplyr::distinct(model, pert_name, combination, combo_dose, PearsonScore, R2) %>%
  plot_ly() %>%
  add_trace(x = ~model, y = ~R2, color = ~pert_name,
            type = "bar", hoverinfo = "text", text = ~R2) %>%
  layout(showlegend = FALSE, xaxis = list(title = "Model"))
p2 <- rf_ccle_auc %>%
  plot_ly() %>%
  add_trace(x = ~rank, y = ~RF.imp.mean, color = ~pert_name, symbol = ~model,
            type = "scatter", mode = "markers",
            hoverinfo = "text", text = ~feature) %>%
  layout(legend = list(orientation = "h"), xaxis = list(type = "log", title = "Rank"),
         yaxis = list(title = "Feature importance"))
subplot(style(p1, showlegend = FALSE), p2, widths = c(0.2, 0.8),
        titleX = T, titleY = T, margin = 0.05)
```
